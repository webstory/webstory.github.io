---
category: 2023
tags: ["2023", "dev", "npm", "esm", "commonjs", "debug", "typescript"]
---

# TypeScriptê¸°ë°˜ NPM íŒ¨í‚¤ì§€ ë§Œë“¤ê¸°

ê°œì¸ì ìœ¼ë¡œ ì‚¬ìš©í•  íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ì–´ì„œ npmì— ë°°í¬í•´ë³´ì•˜ë‹¤.

NPMì— ê°œì¸ ì €ì¥ì†Œë¥¼ ë§Œë“œëŠ” ê±´ ëˆì„ ë‚´ë¯€ë¡œ ê³µê°œ íŒ¨í‚¤ì§€ë¡œ ì˜¬ë ¸ë‹¤. ì‚¬ì‹¤ ë¹„ë°€ íŒ¨í‚¤ì§€ë¥¼ NPMì— ì˜¬ë¦´ ì´ìœ ëŠ” ì „í˜€ ì—†ë‹¤. Gitì„ ì§€ì›í•˜ëŠ” ì•„ë¬´ ì €ì¥ì†Œì— ì˜¬ë¦¬ë©´ ë˜ê¸° ë•Œë¬¸ì´ë‹¤. NPM ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” í¸ë¦¬í•¨ì€ ìˆì§€ë§Œ ì‚¬ì‹¤ ê³µê°œ íŒ¨í‚¤ì§€ë„ ì•„ë‹Œ ë¹„ë°€ íŒ¨í‚¤ì§€ë¥¼ ì˜¬ë ¤ë´¤ì ë‚¨ë“¤ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë‹ˆ ë¬¸ì œë§Œ ë” ìƒê¸¸ ë¿ì´ë‹¤. ì´ ê²½ìš° `package.json`ì— `file:...` í˜•ì‹ìœ¼ë¡œ ì ìœ¼ë©´ ë˜ëŠ”ë° ì´ê±´ ë°‘ì—ì„œ ë‹¤ì‹œ ì„¤ëª…í•˜ê² ë‹¤.

ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” commonjsì™€ esmì„ **ë™ì‹œì— ì§€ì›í•˜ëŠ”** TypeScript ê¸°ë°˜ íŒ¨í‚¤ì§€ë¥¼ ë§Œë“œëŠ” ë²•ì— ëŒ€í•´ ì¤‘ì ì ìœ¼ë¡œ ì„¤ëª…í•˜ê² ë‹¤.

## commonjsì™€ esm

commonjsì™€ esmì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ ëª¨ë“ˆ ì‹œìŠ¤í…œì´ë‹¤. commonjsëŠ” node.jsì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆ ì‹œìŠ¤í…œì´ê³ , esmì€ ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆ ì‹œìŠ¤í…œì´ë‹¤. ë‘˜ì€ í˜¸í™˜ë˜ì§€ ì•ŠëŠ”ë‹¤. ë¸Œë¼ìš°ì €ì—ì„œëŠ” commonjsë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê³ , node.jsì—ì„œëŠ” esmì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. ê·¸ëŸ°ë° nodejs í”„ë¡œì íŠ¸ë¥¼ typescript ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ ê²½ìš° ì´ë²ˆì—ëŠ” ë˜ node.jsì—ì„œ esmì„ ì‚¬ìš©í•œë‹¤. ì—¬ê¸°ì„œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤. ì²˜ìŒì—ëŠ” ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `package.json`ì— `type` ì†ì„±ì„ ì¶”ê°€í•´ ë³´ì•˜ë‹¤.

```json
{
  "type": "module"
}
```

ê·¸ëŸ°ë° TypeScript ì»´íŒŒì¼ëŸ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚¤ì§€ë¥¼ ëª¨ë“ˆë¡œ ì„¤ì •í•  ê²½ìš° nodejsì—ì„œ ì‚¬ìš©í•  ë•Œ ë¬¸ì œê°€ ìƒê¸´ë‹¤. nodejsì—ì„œëŠ” importë¥¼ í•  ë•Œ íŒŒì¼ëª… ë’¤ì— `.js`ë¥¼ ë¶™ì—¬ì•¼ë§Œ ëª¨ë“ˆì„ ì¸ì‹í•˜ëŠ”ë° íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ë¡œ ë¹Œë“œí•œ ê²½ìš° ì´ê²Œ ëˆ„ë½ëœë‹¤. ê·¸ë ‡ë‹¤ê³  í›„ì²˜ë¦¬ ê³¼ì •ì—ì„œ ê°•ì œë¡œ .jsë¥¼ ë¶™ì´ê²Œ ë§Œë“¤ë©´ ì´ë²ˆì—ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ëª¨ë“ˆì„ ë¡œë“œí•  ë•Œ ë¬¸ì œê°€ ìƒê¸´ë‹¤. ë”°ë¼ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ ë•ŒëŠ” ëª¨ë“ˆ íŒ¨í‚¤ì§€ë¡œ ë§Œë“¤ì–´ì„œëŠ” ì•ˆ ëœë‹¤.

ë‹¤ì–‘í•œ ì‚½ì§ˆì´ ìˆì—ˆì§€ë§Œ ê·¸ ê³¼ì •ì„ ë‹¤ ì ì§€ëŠ” ì•Šê² ë‹¤. ì•„ë˜ë¶€í„°ëŠ” ê±°ë‘ì ˆë¯¸í•˜ê³  íŒ¨í‚¤ì§€ë¥¼ ë§Œë“œëŠ” ë°©ë²•ì„ ì„¤ëª…í•˜ê² ë‹¤.

## TypeScript íŒ¨í‚¤ì§€ ë§Œë“¤ê¸°

ê³µí†µ ì˜µì…˜ìœ¼ë¡œ í•  `tsconfig.json`ì„ ë§Œë“ ë‹¤. ë‚˜ëŠ” ì´ë ‡ê²Œ ë§Œë“¤ì—ˆë‹¤.

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    "allowJs": true,
    "target": "ESNext",
    "module": "ESNext",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "declaration": true,
    "outDir": "./build",
    "rootDir": "./src",
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "alwaysStrict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "skipLibCheck": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "src/tests", ".vscode"]
}
```

ë‹¤ìŒ, commonjs(nodejs)ì™€ esm(ë¸Œë¼ìš°ì €, íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ node) ì—ì„œ ì‚¬ìš©í•  tsconfigë¥¼ ê°ê° ë§Œë“ ë‹¤.

tsconfig.browser.json

```json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "module": "ESNext",
    "outDir": "./build/browser"
  }
}
```

tsconfig.node.json

```json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "module": "CommonJS",
    "outDir": "./build/node"
  }
}
```

ê·¸ë¦¬ê³  `package.json`ì„ ì•„ë˜ì™€ ê°™ì´ ë§Œë“ ë‹¤.

package.json

```json
{
  "name": "@webstory/toolbox",
  "version": "1.0.9",
  "description": "JavaScript utility classes toolbox",
  "scripts": {
    "build:node": "tsc --project tsconfig.node.json",
    "build:browser": "tsc --project tsconfig.browser.json",
    "build": "npm run build:node && npm run build:browser",
    "test": "jest",
    "clean": "rimraf build/*"
  },
  "exports": {
    ".": {
      "import": {
        "types": "./build/browser/index.d.ts",
        "default": "./build/browser/index.js"
      },
      "require": {
        "types": "./build/node/index.d.ts",
        "default": "./build/node/index.js"
      }
    }
  },
  "main": "./build/browser/index.js",
  "repository": {
    "type": "git",
    "url": "https://github.com/webstory/toolbox"
  },
  "keywords": ["utility", "util", "utils", "toolbox"],
  "author": "Hoya Kim <hoya@mychar.info>",
  "license": "MIT",
  "devDependencies": {
    "@babel/core": "^7.21.8",
    "@babel/preset-env": "^7.21.5",
    "@babel/preset-typescript": "^7.21.5",
    "@types/jest": "^29.5.1",
    "babel-jest": "^29.5.0",
    "jest": "^29.5.0",
    "prettier": "^2.8.8",
    "rimraf": "^5.0.0",
    "ts-jest": "^29.1.0",
    "typescript": "^5.0.4"
  }
}
```

ë” ìì„¸í•œ ì•ˆë‚´ëŠ” [https://www.typescriptlang.org/docs/handbook/esm-node.html](https://www.typescriptlang.org/docs/handbook/esm-node.html) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

íŒ¨í‚¤ì§€ ì„¤ì •ì—ì„œ ì£¼ì˜í•  ì ì€ `"type": "module"`ì„ ë„£ì§€ ì•ŠëŠ” ê²ƒì´ë‹¤.

`exports` ì„¤ì •ì— ë”°ë¼ commonjsì™€ esm ê°ê°ì˜ íŒ¨í‚¤ì§€ë¥¼ ë¹Œë“œí•œë‹¤. "main"ì€ ì¼ì¢…ì˜ fallbackìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.

ì•„ë˜ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •ê³¼ ì¶”ê°€ í™˜ê²½ ì„¤ì •ì€ íŒ¨í‚¤ì§€ ë¹Œë“œì™€ëŠ” ê´€ê³„ê°€ ì—†ìœ¼ë©° ë‹¤ë§Œ npmì— ê³µê°œí•  íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ ë•Œ ì˜ˆì˜ìƒ? í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ì—¬ ì¶”ê°€í•˜ì˜€ë‹¤.

### í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •

ì¶”ê°€ë¡œ `jest.config.js` íŒŒì¼ì€ ì•„ë˜ì™€ ê°™ì´ ìƒê²¼ë‹¤.

```javascript
module.exports = {
  preset: "ts-jest/presets/js-with-ts-esm",
  testEnvironment: "node",
  testMatch: ["<rootDir>/src/tests/**/*.test.[jt]s"],
};
```

ì—¬ê¸°ì„œ `module.exports` ê°€ ì•„ë‹ˆë¼ `export default` ë¥¼ ì‚¬ìš©í•˜ë©´ jestë¡œë”ê°€ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤. ë”°ë¼ì„œ `module.exports` ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

ë˜í•œ JestëŠ” babelì„ ì‚¬ìš©í•´ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¹Œë“œí•˜ê¸° ë•Œë¬¸ì— babel ê´€ë ¨ íŒ¨í‚¤ì§€ë„ ì„¤ì¹˜í•˜ì˜€ê³  `babel.config.js` íŒŒì¼ë„ ë§Œë“¤ì—ˆë‹¤.

```javascript
module.exports = {
  presets: [
    ["@babel/preset-env", { targets: { node: "current" } }],
    "@babel/preset-typescript",
  ],
};
```

ì¦‰ ìœ„ì˜ `package.json`ì—ì„œ

```json
  "devDependencies": {
    "@babel/core": "^7.21.8",
    "@babel/preset-env": "^7.21.5",
    "@babel/preset-typescript": "^7.21.5",
    "@types/jest": "^29.5.1",
    "babel-jest": "^29.5.0",
    "jest": "^29.5.0",
    "ts-jest": "^29.1.0",
  }
```

ëŠ” ì˜¤ì§ Jestë¥¼ ìœ„í•œ íŒ¨í‚¤ì§€ì´ë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ì•ˆ í•  ì‘ì •ì´ë¼ë©´ ğŸ‘€ ì´ íŒ¨í‚¤ì§€ë“¤ì€ í•„ìš” ì—†ë‹¤.

### ì¶”ê°€ í™˜ê²½ ì„¤ì •

prettierëŠ” ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í–ˆë‹¤. íŒ¨í‚¤ì§€ ë¹Œë“œì— í•„ìš”í•˜ì§€ëŠ” ì•Šìœ¼ë‚˜ ì½”ë“œ ìŠ¤íƒ€ì¼ì„ í†µì¼í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ì˜€ë‹¤.

.prettierrc

```
{
  "tabWidth": 2,
  "useTabs": false,
  "singleQuote": true,
  "trailingComma": "es5",
  "printWidth": 160,
  "pluginSearchDirs": [
    "."
  ]
}
```

### í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ

```bash
npm run test
npm run build
```

## íŒ¨í‚¤ì§€ ë””ë²„ê¹…

NPMì— ë§¤ë²ˆ ì˜¬ë ¤ì„œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê±´ ë²ˆê±°ë¡­ê¸° ë•Œë¬¸ì— ë¹Œë“œëœ íŒ¨í‚¤ì§€ë¥¼ íŒŒì¼ ì‹œìŠ¤í…œ ìƒì—ì„œ ì§ì ‘ ì°¸ê³ í•˜ëŠ” ë°©ë²•ì´ í•„ìš”í•˜ë‹¤.

í”„ë¡œì íŠ¸ í´ë” ë°”ê¹¥, í•˜ì§€ë§Œ ê°™ì€ ë¶€ëª¨ ë””ë ‰í† ë¦¬ì¸ ê³³ì—ì„œ ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê³  ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

package.json

```json
  "dependencies": {
    "@webstory/toolbox": "file:../toolbox"
  },
```

ì°¸ê³ ë¡œ nodejsì—ì„œ typescript ê¸°ë°˜ìœ¼ë¡œ ê°œë°œí•œ íŒ¨í‚¤ì§€ë¥¼ ë””ë²„ê¹…í•  ë•ŒëŠ” `ts-node` íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ì´ë•Œ nodemonê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```json
 "scripts": {
    "build": "tsc",
    "dev": "nodemon --watch \"src/**\" --exec npx ts-node --esm src/index.ts",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
```

toolbox íŒ¨í‚¤ì§€ë¥¼ ì§ì ‘ ì°¸ê³ í•˜ê¸° ë•Œë¬¸ì— ë§Œì•½ toolboxì—ì„œ `npm run clean`ì„ ì‹¤í–‰í•  ê²½ìš° ìœ„ íŒ¨í‚¤ì§€ë“¤ì—ì„œ ë¡œë“œ ì—ëŸ¬ê°€ ë°œìƒí•  ê²ƒì´ë‹¤. ê·¸ê±¸ë¡œ ë‚´ê°€ ì˜¬ë°”ë¥¼ ë²„ì „ì˜ íŒ¨í‚¤ì§€ë¥¼ ë””ë²„ê¹…í•˜ê³  ìˆë‹¤ëŠ” í™•ì‹ ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

ì´ íŒ¨í‚¤ì§€ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ nodejs í”„ë¡œì íŠ¸ ì¦‰ commonjs ê¸°ë°˜ì—ì„œ ì‚¬ìš©í•  ê²½ìš°ì—ë„ ë¬¸ì œê°€ ìƒê¸°ì§€ ì•ŠìŒì„ í™•ì¸í–ˆë‹¤.

## Github CI ì‚¬ìš©

Github Actionsë¥¼ ì‚¬ìš©í•˜ì—¬ CIë¥¼ êµ¬ì¶•í•˜ì˜€ë‹¤.

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .github/workflows/ci.yaml íŒŒì¼ì„ ë§Œë“¤ê³  ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•œë‹¤.

```yaml
name: CI

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Publish to npm
        run: npm publish --access public
        if: github.ref == 'refs/heads/main'
```

ìœ„ yaml íŒŒì¼ì€ ì•„ë˜ì™€ ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.

1. main ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí•˜ë©´
2. ë…¸ë“œ 16ì„ ì„¤ì¹˜í•˜ê³ 
3. npm cië¥¼ ì‹¤í–‰í•˜ì—¬ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ê³ 
4. npm testë¥¼ ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê³ 
5. npm run buildë¥¼ ì‹¤í–‰í•˜ì—¬ íŒ¨í‚¤ì§€ë¥¼ ë¹Œë“œí•˜ê³ 
6. npm publishë¥¼ ì‹¤í–‰í•˜ì—¬ íŒ¨í‚¤ì§€ë¥¼ npmì— ë°°í¬í•œë‹¤.

ì´ë•Œ npm publishë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ NPM_TOKENì„ ì‚¬ìš©í•œë‹¤. ì´ í† í°ì€ npmjs.comì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë‹¤. ê¶Œì¥ ì‚¬í•­ì€ granular access tokenì„ ë°œê¸‰í•˜ë¼ê³  í•˜ëŠ”ë° ì´ê²ƒì€ 365ì¼ê¹Œì§€ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— GitHubìš©ìœ¼ë¡œëŠ” classic tokenì„ ë°œê¸‰ë°›ëŠ” ê±¸ ë” ê¶Œì¥í•œë‹¤. Token expireë¡œ ë°°í¬ê°€ ì•ˆ ë˜ëŠ” ê²Œ í† í°ì´ ìœ ì¶œë˜ëŠ” ê²ƒë³´ë‹¤ ë” ë¬¸ì œì¼ ê²ƒì´ë‹¤.

Githubì—ì„œ ë°°í¬ë¥¼ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ë¡œì»¬ npm publish ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì¡´ì¬í•˜ê¸´ í•˜ì§€ë§Œ ë¸”ë¡œê·¸ì—ì„œëŠ” ì‚­ì œí•˜ì˜€ë‹¤. ë‘ êµ°ë°ì—ì„œ ë°°í¬ë¥¼ ìˆ˜í–‰í•  ê²½ìš° ë²„ì „ ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆì–´ì„œ ì¶”ì²œí•˜ì§€ ì•ŠëŠ”ë‹¤. ì–´ì°¨í”¼ main ë¸Œëœì¹˜ê°€ ì•„ë‹ˆë©´ ë°°í¬ê°€ ìˆ˜í–‰ë˜ì§€ ì•Šìœ¼ë‹ˆ ë¡œì»¬ì—ì„œëŠ” ë°°í¬í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ë‹¤.
